---
import photosData from "../data/photos.json";
import buildInfo from "../data/build.json";
import "../styles/fonts.css";
import "../styles/global.css";
import { existsSync } from 'node:fs';
import { fileURLToPath } from 'node:url';
const { title = 'Ben Allen — Personal Profile', description = 'Sixth Form student · Customer Assistant · Creator' } = Astro.props;
const buildStr = buildInfo ? (`v${buildInfo.version}` + (buildInfo.commit && buildInfo.commit !== 'unknown' ? `+${buildInfo.commit}` : '') + ` ${buildInfo.builtAt}`) : undefined;
const images = (photosData && photosData.images) ? photosData.images : [];
const preferred = images.find(n => /computer|portrait|supermarket|barman|barista/i.test(n)) || images[0];
const heroImage = preferred ? new URL(`/photos/${preferred}`, Astro.site).toString() : undefined;
const posterURL = new URL('../../public/hero/poster.jpg', import.meta.url);
const hasPoster = (()=>{ try { return existsSync(fileURLToPath(posterURL)); } catch { return false; } })();
const ogImage = hasPoster ? new URL('/hero/poster.jpg', Astro.site).toString() : heroImage;
const path = Astro.url.pathname;
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script is:inline>
      // Set initial theme early to avoid flash of wrong theme
      (function(){
        try{
          const stored = localStorage.getItem('theme');
          const mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
          const system = mql && mql.matches ? 'dark' : 'light';
          const theme = (stored === 'light' || stored === 'dark') ? stored : system;
          const root = document.documentElement;
          root.setAttribute('data-theme', theme);
          root.style.colorScheme = theme;
        }catch(e){/* no-op */}
      })();
    </script>
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta name="theme-color" content="#0b0c0f" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <link rel="canonical" href={new URL(Astro.url.pathname, Astro.site)} />
    <meta property="og:url" content={new URL(Astro.url.pathname, Astro.site).toString()} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    {buildStr && <meta name="build" content={buildStr} />}
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <script type="application/ld+json">{JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'Person',
      name: 'Ben Allen',
      email: 'mailto:ben@allen.io',
      url: 'https://ben.allen.io',
      sameAs: ['https://www.linkedin.com/in/ben-allen-uk'],
      jobTitle: 'Student / Customer Assistant'
    })}</script>
  </head>
  <body>
    <a class="skip-link" href="#top">Skip to main content</a>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="/">
          <svg class="logo" width="28" height="28" viewBox="0 0 48 48" aria-hidden="true" focusable="false">
            <defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop stop-color="#62d0ff" offset="0" />
                <stop stop-color="#9bffb2" offset="1" />
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="48" height="48" rx="12" fill="url(#g)" />
            <text x="12" y="31" font-family="Space Grotesk Variable, system-ui, sans-serif" font-weight="700" font-size="18" fill="#0b0c0f">BA</text>
          </svg>
          Ben Allen
        </a>
        <div class="header-right">
          <button id="theme-toggle" class="btn" aria-pressed="false" title="Toggle theme" aria-label="Toggle theme">Theme</button>
          <details class="nav">
            <summary aria-label="Toggle navigation">Menu</summary>
            <nav class="site-nav" aria-label="Primary">
              <a href="/" aria-current={path === '/' ? 'page' : undefined}>Home</a>
              <a href="/cv" aria-current={path.startsWith('/cv') ? 'page' : undefined}>CV</a>
              <a href="https://www.linkedin.com/in/ben-allen-uk" target="_blank" rel="noopener">LinkedIn</a>
              <a class="btn primary" href="mailto:ben@allen.io">Hire Me</a>
            </nav>
          </details>
        </div>
      </div>
      <div class="progress" id="progress" aria-hidden="true"></div>
    </header>

    <main id="top" class="container">
      <slot />
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>© {new Date().getFullYear()} Ben Allen. All rights reserved.</p>
        {buildStr && (
          <p class="muted"><small>{buildStr}</small> · <a href="/version.txt">version.txt</a></p>
        )}
      </div>
    </footer>
    <script src={buildStr ? `/scripts/theme.js?v=${(buildInfo && (buildInfo.commit || buildInfo.builtAt)) || ''}` : '/scripts/theme.js'} defer></script>
    <script src={buildStr ? `/scripts/site.js?v=${(buildInfo && (buildInfo.commit || buildInfo.builtAt)) || ''}` : '/scripts/site.js'} defer></script>
  </body>
  </html>
